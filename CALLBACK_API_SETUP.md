# Настройка VK Callback API для параллельной обработки сообщений

## Проблема

Long Poll API обрабатывает сообщения **последовательно** - пока один пользователь не завершит диалог, следующий будет ждать. Это создаёт очереди при большом количестве одновременных пользователей.

## Решение - Callback API

Callback API позволяет VK отправлять события напрямую на ваш сервер через HTTP запросы, что даёт возможность обрабатывать **множество запросов параллельно**.

## Настройка Callback API в VK

### 1. Откройте настройки сообщества

1. Перейдите в ваше сообщество ВКонтакте
2. Управление → Работа с API → Callback API

### 2. Настройте Callback API

1. **Версия API**: Выберите **5.199** или выше
2. **Секретный ключ**: Убедитесь что указан тот же секрет, что и в `.env` (`VK_SECRET`)
3. **Адрес сервера**: Укажите `https://ваш-домен.com/bot/webhook`

   Например: `https://isko.online/bot/webhook`

### 3. Типы событий

Включите следующие типы событий:
- ✅ **message_new** - Новое сообщение

### 4. Подтверждение сервера

При сохранении адреса сервера, VK отправит запрос подтверждения. Бот автоматически ответит кодом подтверждения из переменной `VK_CONFIRMATION`.

Если видите ошибку подтверждения:
1. Убедитесь что сервер запущен
2. Убедитесь что `VK_CONFIRMATION` в `.env` правильный (берётся из настроек Callback API в VK)
3. Проверьте что `BOT_MODE=webhook` в `.env`

### 5. Проверка работы

После успешной настройки:

1. В настройках Callback API должна быть **зелёная галочка** возле адреса сервера
2. Отправьте сообщение боту - он должен ответить
3. В логах сервера должны появиться записи: `Webhook event processed: message_new`

## Настройка на VPS

### 1. Обновите .env

```bash
nano /var/www/voting-system/.env
```

Измените следующие переменные:

```env
# Режим работы бота: 'polling' или 'webhook'
BOT_MODE=webhook

# URL вашего сайта (для webhook)
SITE_URL=https://ваш-домен.com
```

### 2. Перезапустите приложение

```bash
pm2 restart voting-system
```

### 3. Проверьте логи

```bash
pm2 logs voting-system
```

Должно быть сообщение:
```
VK Бот запущен в режиме WEBHOOK!
Ожидание событий на https://ваш-домен.com/bot/webhook
```

### 4. Проверьте webhook endpoint

```bash
curl https://ваш-домен.com/bot/health
```

Ответ должен быть:
```json
{
  "status": "ok",
  "mode": "webhook",
  "timestamp": "2024-11-01T12:00:00.000Z"
}
```

## Возврат к Long Poll

Если нужно вернуться к Long Poll (например, для локальной разработки):

1. В `.env` измените:
   ```env
   BOT_MODE=polling
   ```

2. Перезапустите:
   ```bash
   pm2 restart voting-system
   ```

## Преимущества Callback API

✅ **Параллельная обработка** - множество пользователей могут голосовать одновременно
✅ **Быстрее** - меньше задержек, нет polling'а
✅ **Надёжнее** - VK гарантирует доставку событий
✅ **Масштабируемость** - подходит для большого количества пользователей

## Недостатки Callback API

❌ **Требует HTTPS** - нужен SSL сертификат
❌ **Требует публичный URL** - не работает на localhost
❌ **Сложнее отладка** - не видно событий напрямую

## Рекомендации

- **Production**: Используйте **webhook** (Callback API)
- **Development** (локально): Используйте **polling** (Long Poll API)
- Всегда используйте HTTPS на production
- Следите за логами для отладки

## Решение проблем

### Ошибка подтверждения сервера

```
Не удалось проверить адрес: сервер вернул неверный код подтверждения
```

**Решение:**
1. Проверьте `VK_CONFIRMATION` в `.env`
2. Убедитесь что сервер запущен
3. Проверьте логи: `pm2 logs voting-system`

### События не приходят

```
Бот не отвечает на сообщения
```

**Решение:**
1. Проверьте что типы событий включены в VK
2. Убедитесь что `BOT_MODE=webhook`
3. Проверьте логи на ошибки
4. Убедитесь что firewall не блокирует запросы от VK

### SSL ошибки

```
VK не может подключиться к серверу
```

**Решение:**
1. Убедитесь что SSL сертификат действителен
2. Проверьте: `certbot certificates`
3. Обновите если нужно: `certbot renew`

## Поддержка

При проблемах с настройкой:
1. Проверьте логи: `pm2 logs voting-system`
2. Проверьте статус: `pm2 status`
3. Проверьте webhook endpoint: `curl https://ваш-домен.com/bot/health`
