# Инструкция по установке и запуску

## Требования

- Node.js v18 или выше
- npm или yarn
- (Опционально) Docker и Docker Compose

## Метод 1: Локальная установка (Windows)

### Шаг 1: Установка зависимостей

```bash
npm install
```

### Шаг 2: Настройка окружения

Отредактируйте файл `.env` и заполните необходимые данные:

```env
# VK Bot - получите в настройках группы VK
VK_TOKEN=ваш_токен_vk_бота
VK_GROUP_ID=id_вашей_группы
VK_CONFIRMATION=код_подтверждения
VK_SECRET=секретный_ключ_для_api

# Придумайте надёжные пароли
ADMIN_PASSWORD=ваш_надёжный_пароль
JWT_SECRET=случайная_строка_минимум_32_символа
VOTE_SALT=случайная_строка_для_хеширования
SESSION_SECRET=ещё_одна_случайная_строка
```

### Шаг 3: Инициализация базы данных

```bash
npm run init-db
```

### Шаг 4: Запуск

#### Вариант A: Автоматический запуск (Windows)

Просто запустите `start.bat` двойным кликом.

#### Вариант B: Ручной запуск

Откройте два терминала:

**Терминал 1 - Сервер:**
```bash
npm start
```

**Терминал 2 - VK Бот:**
```bash
node src/bot.js
```

### Шаг 5: Доступ к системе

- **Публичная страница:** http://localhost:3000
- **Админ панель:** http://localhost:3000/admin

**Логин по умолчанию:**
- Username: `admin`
- Password: `Admin123!` (или тот что вы указали в .env)

⚠️ **ВАЖНО:** Измените пароль после первого входа!

## Метод 2: Запуск через Docker

### Шаг 1: Настройка .env

Убедитесь что файл `.env` заполнен корректно.

### Шаг 2: Запуск контейнеров

```bash
docker-compose up -d
```

### Шаг 3: Инициализация БД (первый запуск)

```bash
docker-compose exec app npm run init-db
```

### Шаг 4: Проверка статуса

```bash
docker-compose ps
```

### Просмотр логов

```bash
# Все сервисы
docker-compose logs -f

# Только сервер
docker-compose logs -f app

# Только бот
docker-compose logs -f bot
```

### Остановка

```bash
docker-compose down
```

## Настройка VK бота

### 1. Создание бота

1. Перейдите в настройки вашей группы VK
2. Управление → Работа с API
3. Создайте ключ доступа с правами:
   - Управление сообществом
   - Сообщения сообщества

### 2. Настройка Callback API

1. В разделе "Callback API" включите API
2. Укажите URL вашего сервера (если есть)
3. Скопируйте строку подтверждения в `.env` как `VK_CONFIRMATION`
4. Создайте секретный ключ и укажите в `.env` как `VK_SECRET`

### 3. Включение сообщений

1. Сообщения → Настройки для бота
2. Включите "Возможности ботов"
3. Разрешите добавление в беседы

## Управление системой

### Добавление смен

1. Войдите в админ панель
2. Раздел "Управление сменами"
3. Нажмите "Добавить смену"
4. Заполните название и описание

### Добавление кандидатов

1. В админ панели → "Управление кандидатами"
2. Нажмите "Добавить кандидата"
3. Выберите смену
4. Укажите имя и описание кандидата

### Запуск голосования

1. В разделе "Управление голосованием"
2. Нажмите кнопку "Запустить"
3. Голосование станет доступно в VK боте

### Экспорт результатов

1. Раздел "Журнал голосов"
2. Кнопка "Экспорт в CSV"
3. Файл откроется в Excel с полной статистикой

## Резервное копирование

### Автоматическое (Docker)

Контейнер `backup` автоматически создаёт копии каждый час в папке `backups/`.

### Ручное

```bash
npm run backup
```

Или просто скопируйте файл:
```bash
copy src\database\voting.db backups\voting_backup.db
```

### Восстановление из бекапа

```bash
# Остановите сервер
# Замените файл БД
copy backups\voting_YYYYMMDD_HHMMSS.db src\database\voting.db
# Запустите сервер снова
```

## Решение проблем

### Бот не отвечает

1. Проверьте токен VK в `.env`
2. Убедитесь что бот запущен: `node src/bot.js`
3. Проверьте логи в `logs/app.log`

### Ошибка базы данных

```bash
# Переинициализируйте БД
npm run init-db
```

### Не могу войти в админку

1. Проверьте логин/пароль в `.env`
2. Очистите localStorage браузера (F12 → Application → Local Storage)
3. Попробуйте другой браузер

### Порт занят

Измените порт в `.env`:
```env
PORT=3001
```

## Мониторинг

### Просмотр логов

- `logs/app.log` - все события приложения
- `logs/error.log` - только ошибки

### Health check

```bash
curl http://localhost:3000/health
```

Должен вернуть: `{"status":"ok","timestamp":"..."}`

## Производительность

### Рекомендуемые характеристики сервера

- **CPU:** 1-2 ядра
- **RAM:** 1-2 GB
- **Диск:** 5 GB
- **Сеть:** 1 Мбит/с

### Ожидаемая нагрузка

- До 500 одновременных подключений
- До 100 голосов в минуту
- WebSocket для 200+ пользователей

## Безопасность

### Обязательно измените:

1. ✅ `ADMIN_PASSWORD` - пароль администратора
2. ✅ `JWT_SECRET` - секрет для токенов (минимум 32 символа)
3. ✅ `VOTE_SALT` - соль для хеширования голосов
4. ✅ `SESSION_SECRET` - секрет сессий

### Генерация случайных строк (PowerShell):

```powershell
# Для JWT_SECRET и других
-join ((48..57) + (65..90) + (97..122) | Get-Random -Count 32 | % {[char]$_})
```

### Рекомендации:

- Используйте HTTPS в продакшене
- Регулярно обновляйте зависимости: `npm update`
- Делайте бекапы перед важными событиями
- Ограничьте доступ к админ панели по IP (через Nginx/Apache)

## Поддержка

При возникновении проблем:

1. Проверьте логи: `logs/app.log`
2. Проверьте статус сервисов: `docker-compose ps` или Process Manager
3. Перезапустите систему

## Лицензия

MIT
