# Система голосования "Парус" - Полное руководство

## Описание системы

Это веб-приложение для голосования за кандидатов на должность старшего вожатого в детском лагере "Парус". Система поддерживает голосование по сменам с использованием VK бота.

### Основные возможности

**Система голосования:**
- Голосование по сменам
- На каждой смене пользователь выбирает ОДИН вариант:
  - Один из кандидатов
  - "Против всех"
  - "Воздержаться"
- Автоматическое создание вариантов "Против всех" и "Воздержаться" при создании смены
- Один пользователь = один голос на смену
- Анонимное голосование через VK бота с использованием псевдонимов

**Административная панель:**
- Управление статусом голосования (запуск, пауза, остановка, сброс)
- Управление сменами (создание, деактивация, удаление)
- Управление кандидатами (добавление, удаление)
- Журнал голосов в реальном времени
- Экспорт данных в CSV
- Просмотр статистики

**VK Бот:**
- Регистрация пользователей (ФИО + псевдоним)
- Выбор смены
- Выбор кандидата или специального варианта
- Подтверждение голоса
- Просмотр своей статистики

---

## Установка и запуск

### Требования
- Node.js v18 или выше
- npm
- VK API Token (для бота)
- VK Group ID

### 1. Клонирование и установка зависимостей

```bash
# Перейти в директорию проекта
cd "c:\Users\Vovan\OneDrive\Рабочий стол\GGG"

# Установить зависимости
npm install
```

### 2. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
# VK Bot Configuration
VK_TOKEN=ваш_токен_вк_группы
VK_GROUP_ID=ваш_id_группы

# Server Configuration
PORT=3000
NODE_ENV=development

# JWT Secret (измените на случайную строку)
JWT_SECRET=ваш_секретный_ключ_для_jwt

# Admin Credentials (первый администратор)
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin123
```

**Как получить VK_TOKEN:**
1. Создайте сообщество ВКонтакте
2. Перейдите в Управление → Настройки → Работа с API
3. Создайте ключ доступа с правами: messages, groups
4. Скопируйте токен в `.env`

**VK_GROUP_ID:**
- Числовой ID вашего сообщества (без минуса)

### 3. Инициализация базы данных

```bash
# Создать базу данных и структуру
npm run init-db

# Создать администратора
npm run init-db:admin
```

Будет создана база данных `voting.db` и первый администратор с учетными данными из `.env`.

### 4. Запуск приложения

**Для разработки (с автоперезагрузкой):**
```bash
npm run dev
```

**Для продакшена:**
```bash
npm start
```

Это запустит:
- Веб-сервер на порту 3000
- VK бота (Long Poll)
- WebSocket сервер для обновлений в реальном времени

### 5. Доступ к системе

- **Веб-сайт:** http://localhost:3000
- **Админ-панель:** http://localhost:3000/admin (логин: admin, пароль: admin123)
- **VK Бот:** Напишите боту в сообщениях группы

---

## Структура проекта

```
GGG/
├── src/
│   ├── config/
│   │   ├── database.js          # Подключение к БД
│   │   ├── constants.js         # Константы и сообщения
│   │   └── jwt.js              # JWT конфигурация
│   ├── controllers/
│   │   ├── adminController.js   # API админ-панели
│   │   ├── publicController.js  # Публичное API
│   │   └── voteController.js    # Логика голосования
│   ├── models/
│   │   ├── Admin.js            # Модель администраторов
│   │   ├── Candidate.js        # Модель кандидатов
│   │   ├── Settings.js         # Модель настроек
│   │   ├── Shift.js            # Модель смен
│   │   ├── User.js             # Модель пользователей
│   │   └── Vote.js             # Модель голосов
│   ├── middleware/
│   │   ├── auth.js             # Проверка JWT токенов
│   │   └── errorHandler.js     # Обработка ошибок
│   ├── routes/
│   │   ├── adminRoutes.js      # API роутеры админки
│   │   ├── publicRoutes.js     # Публичные роутеры
│   │   └── voteRoutes.js       # Роутеры голосования
│   ├── database/
│   │   ├── init.sql            # SQL схема БД
│   │   ├── init-admin.js       # Скрипт создания админа
│   │   ├── migrate-voting-system.sql  # Миграция системы голосования
│   │   ├── run-migration.js    # Запуск миграций
│   │   ├── remove-photo-url.sql # Миграция удаления photo_url
│   │   └── run-migration-photo.js # Запуск миграции photo_url
│   ├── utils/
│   │   └── logger.js           # Логирование
│   ├── bot.js                  # VK бот
│   └── server.js               # Express сервер
├── public/
│   ├── css/
│   │   ├── style.css           # Основные стили
│   │   └── admin.css           # Стили админки
│   ├── js/
│   │   ├── app.js              # Клиентская логика
│   │   └── admin.js            # Админ-панель логика
│   ├── index.html              # Главная страница
│   ├── admin.html              # Страница входа админа
│   └── admin-dashboard.html    # Админ-панель
├── .env                        # Переменные окружения
├── package.json                # Зависимости проекта
└── GUIDE.md                    # Это руководство
```

---

## Использование системы

### Административная панель

#### Вход в админ-панель
1. Откройте http://localhost:3000/admin
2. Введите логин и пароль (по умолчанию: admin / admin123)

#### Управление голосованием

**Статусы голосования:**
- **Не начато** - голосование еще не запущено
- **Активно** - пользователи могут голосовать
- **Приостановлено** - временная пауза
- **Завершено** - голосование остановлено (нельзя возобновить)

**Действия:**
- **Запустить** - активировать голосование
- **Приостановить** - временно остановить (можно возобновить)
- **Остановить** - завершить голосование (необратимо)
- **Сбросить** - удалить все настройки и данные

#### Управление сменами

1. Нажмите "Добавить смену"
2. Заполните:
   - Название смены (обязательно)
   - Описание (опционально)
   - Даты начала и окончания (опционально)
3. При создании автоматически добавляются варианты:
   - "Против всех"
   - "Воздержаться"

**Действия со сменой:**
- **Деактивировать** - скрыть смену (кандидаты тоже скроются)
- **Активировать** - показать смену снова
- **Удалить** - удалить смену, всех кандидатов и голоса (необратимо)

#### Управление кандидатами

1. Нажмите "Добавить кандидата"
2. Выберите смену
3. Введите имя и описание кандидата
4. Нажмите "Создать"

**Важно:** Варианты "Против всех" и "Воздержаться" создаются автоматически при создании смены. Не нужно создавать их вручную.

**Удаление кандидата:**
- Удаляет кандидата и все связанные с ним голоса (необратимо)

#### Журнал голосов

Показывает все голоса в реальном времени:
- Время голосования
- VK ID (кликабельный, открывает профиль ВК)
- ФИО пользователя
- Псевдоним (отображается публично)
- Смена
- За кого проголосовал
- Тип голоса (цветная метка)

**Цветовые метки:**
- 🟢 Зеленый - голос за кандидата
- 🔴 Красный - "Против всех"
- ⚪ Серый - "Воздержался"

**Экспорт:**
- Нажмите "Экспорт в CSV" для скачивания всех голосов

---

### Работа с VK ботом

#### Команды бота

- `/start` - Начать работу с ботом
- `/vote` - Начать процесс голосования
- `/shifts` - Показать список смен
- `/status` - Проверить статус голосования
- `/mystats` - Посмотреть свою статистику голосования
- `/help` - Показать справку

#### Процесс голосования

1. **Регистрация (только первый раз):**
   - Введите ФИО (Фамилия Имя Отчество)
   - Придумайте псевдоним (будет виден всем)

2. **Выбор смены:**
   - Бот покажет список активных смен
   - Выберите смену

3. **Выбор варианта:**
   - Бот покажет всех кандидатов
   - Плюс варианты "Против всех" и "Воздержаться"
   - Выберите ОДИН вариант

4. **Подтверждение:**
   - Проверьте свой выбор
   - Нажмите "Подтвердить"

5. **Готово:**
   - Голос учтен
   - Можете голосовать на других сменах

**Ограничения:**
- Один голос на смену
- Нельзя изменить голос после подтверждения
- Голосование возможно только когда статус "Активно"

---

## База данных

### Таблицы

**shifts** - Смены
- id, name, description, start_date, end_date, is_active, created_at

**candidates** - Кандидаты
- id, shift_id, name, description, vote_count, is_active, created_at
- vote_count обновляется при каждом голосе

**users** - Пользователи
- id, vk_id, full_name, nickname, created_at

**votes** - Голоса
- id, user_id, shift_id, candidate_id, vote_type, vote_hash, created_at
- vote_type: 'candidate', 'against_all', 'abstain'
- UNIQUE(user_id, shift_id) - один голос на смену

**admins** - Администраторы
- id, username, password_hash, last_login, created_at

**settings** - Настройки
- key, value, updated_at
- Хранит voting_status и другие настройки

**audit_logs** - Логи действий
- id, admin_id, action, details, ip_address, created_at

### Миграции

Если вы обновляете систему из старой версии (с голосованием ЗА/ПРОТИВ):

```bash
# Миграция на новую систему голосования
node src/database/run-migration.js

# Удаление поля photo_url (если есть)
node src/database/run-migration-photo.js
```

**Внимание:** Миграции создают резервные копии (backup таблицы) перед изменениями.

---

## API Эндпоинты

### Публичные (без авторизации)

```
GET  /api/status           - Статус голосования
GET  /api/shifts           - Список активных смен
GET  /api/candidates/:id   - Кандидаты смены
GET  /api/results/:shiftId - Результаты голосования
POST /api/votes            - Создать голос (из бота)
GET  /api/users/:vkId/stats - Статистика пользователя
```

### Административные (требуют JWT токена)

```
POST /api/admin/auth/login  - Вход администратора

GET    /api/admin/shifts         - Список всех смен
POST   /api/admin/shifts         - Создать смену
PUT    /api/admin/shifts/:id     - Обновить смену
DELETE /api/admin/shifts/:id     - Удалить смену

GET    /api/admin/candidates     - Список всех кандидатов
POST   /api/admin/candidates     - Создать кандидата
DELETE /api/admin/candidates/:id - Удалить кандидата

GET  /api/admin/votes            - Все голоса
GET  /api/admin/export/votes     - Экспорт в CSV

POST /api/admin/voting/control   - Управление голосованием
     body: { action: 'start'|'stop'|'pause'|'reset' }
```

---

## Безопасность

### Защита администратора
- Пароли хешируются с помощью bcrypt
- Сессии на основе JWT токенов (24 часа)
- Все административные действия логируются

### Защита голосования
- Каждый голос имеет уникальный хеш
- Ограничение: один голос на смену
- Проверка статуса голосования перед принятием голоса
- Транзакции БД для атомарности операций

### Рекомендации
- Смените пароль администратора после первого входа
- Используйте сильный JWT_SECRET
- Не публикуйте .env файл
- Включите HTTPS в продакшене

---

## Решение проблем

### Ошибка "EADDRINUSE: address already in use"
Порт 3000 уже занят. Решение:
```bash
# Windows
netstat -ano | findstr :3000
taskkill /PID <PID> /F

# Или измените порт в .env
PORT=3001
```

### Ошибка "Database file not found"
База данных не создана. Решение:
```bash
npm run init-db
npm run init-db:admin
```

### Бот не отвечает
1. Проверьте VK_TOKEN в .env
2. Проверьте, что бот запущен (в логах должно быть "VK Bot started")
3. Убедитесь, что в настройках группы ВК:
   - Включены сообщения сообщества
   - Long Poll API включен
   - Бот добавлен в менеджеры

### "Cannot read properties of null (reading 'name')"
Это старая ошибка, исправлена в последней версии. Убедитесь, что используете актуальный код.

### Кандидаты показывают "undefined"
Запустите миграцию системы голосования:
```bash
node src/database/run-migration.js
```

---

## Обслуживание

### Резервное копирование
```bash
# Создать копию базы данных
cp voting.db voting.db.backup

# С датой
cp voting.db "voting.db.backup.$(date +%Y%m%d)"
```

### Очистка данных
```bash
# Сбросить всю систему через админ-панель
# Или вручную удалить базу и пересоздать
del voting.db
npm run init-db
npm run init-db:admin
```

### Просмотр логов
Логи выводятся в консоль. Для сохранения в файл:
```bash
npm start > logs.txt 2>&1
```

---

## Технологии

**Backend:**
- Node.js v18+
- Express.js 4.x
- SQLite3 (better-sqlite3)
- JWT (jsonwebtoken)
- bcrypt (для паролей)
- Socket.io 4.x (WebSocket)
- VK API (vk-io)

**Frontend:**
- Vanilla JavaScript (ES6+)
- HTML5 / CSS3
- Socket.io-client (реальное время)

**База данных:**
- SQLite3 (локальный файл voting.db)

---

## Лицензия и поддержка

Система разработана для детского лагеря "Парус".

При возникновении вопросов обращайтесь к разработчику.

---

**Версия:** 2.0 (Система единого выбора)
**Дата обновления:** 27.10.2025
